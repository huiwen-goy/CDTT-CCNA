---
title: "CDTT-CCNA data analysis"
output: html_document
---

```{r, echo=FALSE, results='hide', warning=FALSE, message=FALSE}

# Read packages
library(ggplot2)

# Read data
all_data <- read.csv('ccna.full.05.27.2020.csv', header=TRUE, blank.lines.skip = TRUE,
                 stringsAsFactors=FALSE, na.strings=c("NA", "<NA>", "#NULL!", "", " "))

# Exclude some rows and select only a small subset of variables
data <- subset(all_data, 
               Faisal..April..Allison == 1, 
               select=c(Age.ab, Cognitive.category, MoCA.Total...30., L250:R8000, T1.corrected.SRT))

# Rename some variables
colnames(data)[colnames(data) == "Age.ab"] <- "Age"
colnames(data)[colnames(data) == "MoCA.Total...30."] <- "MoCA.total"
colnames(data)[colnames(data) == "T1.corrected.SRT"] <- "SRT"

# Recode four cognitive categories to two
data$Cog.cat[data$Cognitive.category == "MCI-NoSubjective"] <- "MCI"
data$Cog.cat[data$Cognitive.category == "MCI"] <- "MCI"
data$Cog.cat[data$Cognitive.category == "Normal"] <- "Normal"
data$Cog.cat[data$Cognitive.category == "SCI"] <- "Normal"
# Order factor levels
data$Cog.cat <- factor(data$Cog.cat, levels = c("Normal", "MCI"))

# Recode two cognitive categories to numeric
data$Cog.cat.num[data$Cog.cat == "Normal"] <- 0
data$Cog.cat.num[data$Cog.cat == "MCI"] <- 1

# Recode MoCA scores above and below normal cutoff of 26
data$MoCA.cat[data$MoCA.total >= 26] <- "≥26"
data$MoCA.cat[data$MoCA.total < 26] <- "<26"
# Order factor levels
data$MoCA.cat <- factor(data$MoCA.cat, levels = c("≥26", "<26"))

# Recode two MoCA categories to numeric
data$MoCA.cat.num[data$MoCA.total >= 26] <- 0
data$MoCA.cat.num[data$MoCA.total < 26] <- 1

# Calculate 4f-PTA better ear
data$LPTA <- (data$L500 + data$L1000 + data$L2000 + data$L4000) / 4
data$RPTA <- (data$R500 + data$R1000 + data$R2000 + data$R4000) / 4
data$PTA.better <- pmin(data$LPTA, data$RPTA)

# Classify participants according to PTA
data$PTA.group[data$PTA.better <= 20] <- "Normal"
data$PTA.group[data$PTA.better > 20 & data$PTA.better < 40] <- "Mild"
data$PTA.group[data$PTA.better >= 40] <- "Moderate"
# Order factor levels
data$PTA.group <- factor(data$PTA.group, levels = c("Normal", "Mild", "Moderate"))

# Drop three data rows
data2 <- data[-which(data$PTA.better == 18.75 & data$SRT == 2.476), ]
data2 <- data2[is.na(data2$SRT)==FALSE, ]

rm(list = c('all_data', 'data'))

```

**Note: PTA categories**
  
1. "Normal": Better ear 4f-PTA ≤ 20 dB HL  
2. "Mild": Better ear 4f-PTA > 20 dB HL and < 40 dB HL  
3. "Moderate": Better ear 4f-PTA ≥ 40 dB HL  

**Note: Data exclusion**
  
1. Original dataset had n=264. 
2. Dropped single outlier (PTA < 19 & SRT > 2).
3. Dropped two participants with missing SRT data.
4. All plots and analyses use n=261 now.
  
### Does cognition change the relationship between PTA and SRT?
  
*Note: PTA (x-axis) is always jittered slightly to decrease overlap of points.*
  
#### Figure 1: Three PTA groups with normal, mild, and moderate hearing loss
  
Conclusion: MoCA changes the relationship between PTA-SRT only for the mild hearing loss group.
    
```{r, echo=FALSE, results='hide', fig.keep='all'}

# SRT ~ PTA regression for 3 PTA Groups
m.normal <- lm(SRT ~ PTA.better, subset(data2, PTA.group == "Normal"))
m.mild <- lm(SRT ~ PTA.better, subset(data2, PTA.group == "Mild"))
m.moderate <- lm(SRT ~ PTA.better, subset(data2, PTA.group == "Moderate"))

# Plot SRT ~ PTA, MoCA colour-coded (gradient)
# Cordinates for geom_segments were manually calculated from slopes and intercepts in above models
ggplot(data2, aes(x = jitter(PTA.better), y = SRT, color = MoCA.total)) +
  geom_point(size = 3) + 
  scale_colour_gradient2(low = "red", mid = "white", high = "blue", midpoint = 25, name = "MoCA total") +
  scale_x_continuous(name = "PTA better ear (dB HL)", limits = c(-5,65), expand = c(0,0), breaks = seq(-5,65,5)) + 
  scale_y_continuous(name = "SRT (dB SNR)", limits = c(-14,4), expand = c(0,0), breaks = seq(-14,4,2)) + 
  theme(axis.title = element_text(size = 20), 
        axis.text = element_text(colour = "black", size = 16), 
        text = element_text(size = 16)) + 
  theme(legend.position = c(0.15, 0.75), 
        legend.title = element_text(size = 16), 
        legend.text = element_text(size = 12), 
        legend.margin = margin(0.25, 0.25, 0.5, 0.25, "cm")) + 
  theme(plot.margin = unit(c(0.5, 0.5, 0.25, 0.25), "cm")) + 
  theme(panel.background = element_rect(fill = 'black', colour = 'black'), 
        panel.grid = element_line(colour = '#999999')) + 
  geom_segment(aes(x = 0, y = -11.53753, xend = 20, yend = -10.87393), color = "yellow1", size = 0.6) + 
  geom_segment(aes(x = 20, y = -11.05101, xend = 40, yend = -7.81521), color = "yellow1", size = 0.6) + 
  geom_segment(aes(x = 40, y = -6.48412, xend = 64, yend = -0.41644), color = "yellow1", size = 0.6)

``` 
 
*Across all participants*
```{r, echo=TRUE}
summary(lm(SRT ~ PTA.better * MoCA.total, data2))
```

*Normal hearing only*
```{r, echo=TRUE}
summary(lm(SRT ~ PTA.better * MoCA.total, subset(data2, PTA.group == "Normal")))
```

*Mild hearing loss only*
```{r, echo=TRUE}
summary(lm(SRT ~ PTA.better * MoCA.total, subset(data2, PTA.group == "Mild")))
```

*Moderate hearing loss only*
```{r, echo=TRUE}  
summary(lm(SRT ~ PTA.better * MoCA.total, subset(data2, PTA.group == "Moderate")))
```
 
#### Figure 2: Three PTA groups, by MoCA categories (≥26 vs. <26)
  
```{r, echo=FALSE, results='hide', fig.keep='all'}

# Separating PTA Groups into MoCA ≥ 26 and MoCA < 26
nh.moca26 <- lm(SRT ~ PTA.better, subset(data2, PTA.group == "Normal" & MoCA.cat == "≥26"))
nh.moca25 <- lm(SRT ~ PTA.better, subset(data2, PTA.group == "Normal" & MoCA.cat == "<26"))
mild.moca26 <- lm(SRT ~ PTA.better, subset(data2, PTA.group == "Mild" & MoCA.cat == "≥26"))
mild.moca25 <- lm(SRT ~ PTA.better, subset(data2, PTA.group == "Mild" & MoCA.cat == "<26"))
moderate.moca26 <- lm(SRT ~ PTA.better, subset(data2, PTA.group == "Moderate" & MoCA.cat == "≥26"))
moderate.moca25 <- lm(SRT ~ PTA.better, subset(data2, PTA.group == "Moderate" & MoCA.cat == "<26"))
  
# Plot SRT ~ PTA, MoCA colour-coded & two regression lines per PTA Group
# Coordinates for geom_segment lines were manually calculated from slope and intercepts in above models
ggplot(data2, aes(x = jitter(PTA.better), y = SRT, color = MoCA.cat)) +
  geom_point(size = 3) + 
  scale_colour_manual(labels = c("26+", "<26"), name="MoCA Category", values=c("dodgerblue1", "orangered1")) +
  scale_x_continuous(name = "PTA better ear (dB HL)", limits = c(-5,65), expand = c(0,0), breaks = seq(-5,65,5)) + 
  scale_y_continuous(name = "SRT (dB SNR)", limits = c(-14,4), expand = c(0,0), breaks = seq(-14,4,2)) + 
  theme(axis.title = element_text(size = 20), 
    axis.text = element_text(colour = "black", size = 16), 
    text = element_text(size = 16)) + 
  theme(legend.position = c(0.2, 0.75), 
        legend.title = element_text(size = 16), 
        legend.text = element_text(size = 12), 
        legend.margin = margin(0.25, 0.25, 0.5, 0.25, "cm")) +
  theme(plot.margin = unit(c(0.5, 0.5, 0.25, 0.25), "cm")) +
  geom_segment(aes(x = 0, y = -11.5635, xend = 20, yend = -10.9709), color = "dodgerblue3", size = 0.6) + 
  geom_segment(aes(x = 0, y = -11.5103, xend = 20, yend = -10.7633), color = "orangered3", size = 0.6) + 
  geom_segment(aes(x = 20, y = -10.5638, xend = 40, yend = -8.4318), color = "dodgerblue3", size = 0.6) + 
  geom_segment(aes(x = 20, y = -11.55917, xend = 40, yend = -7.45417), color = "orangered3", size = 0.6) + 
  geom_segment(aes(x = 40, y = -7.4127, xend = 64, yend = -0.3399), color = "dodgerblue3", size = 0.6) + 
  geom_segment(aes(x = 40, y = -4.4721, xend = 64, yend = -2.1489), color = "orangered3", size = 0.6)

```
  
*Mild hearing loss only*: Effect of PTA only
```{r, echo=TRUE}
summary(lm(SRT ~ PTA.better * MoCA.cat.num, subset(data2, PTA.group == "Mild")))
```

#### Figure 3: Three PTA groups, by Faisal's cognitive categories (normal vs. MCI)
  
```{r, echo=FALSE, results='hide', fig.keep='all'}

# Separating hearing groups into Normal and MCI (Faisal's categories)
nh.normal <- lm(SRT ~ PTA.better, subset(data2, PTA.group == "Normal" & Cog.cat == "Normal"))
nh.mci <- lm(SRT ~ PTA.better, subset(data2, PTA.group == "Normal" & Cog.cat == "MCI"))
mild.normal <- lm(SRT ~ PTA.better, subset(data2, PTA.group == "Mild" & Cog.cat == "Normal"))
mild.mci <- lm(SRT ~ PTA.better, subset(data2, PTA.group == "Mild" & Cog.cat == "MCI"))
moderate.normal <- lm(SRT ~ PTA.better, subset(data2, PTA.group == "Moderate" & Cog.cat == "Normal"))
moderate.mci <- lm(SRT ~ PTA.better, subset(data2, PTA.group == "Moderate" & Cog.cat == "MCI"))

# Plot SRT ~ PTA, cognitive category colour-coded (blue = normal, red = MCI)
# Coordinates for geom_segments were manually calculated using slopes and intercepts from above models
ggplot(data2, aes(x = jitter(PTA.better), y = SRT, color = Cog.cat)) +
  geom_point(size = 3) + 
  scale_colour_manual(labels = c("Normal", "MCI"), name="Cognitive Category", values=c("dodgerblue1", "orangered1")) +
  scale_x_continuous(name = "PTA better ear (dB HL)", limits = c(-5,65), expand = c(0,0), breaks = seq(-5,65,5)) + 
  scale_y_continuous(name = "SRT (dB SNR)", limits = c(-14,4), expand = c(0,0), breaks = seq(-14,4,2)) + 
  theme(axis.title = element_text(size = 20), 
    axis.text = element_text(colour = "black", size = 16), 
    text = element_text(size = 16)) + 
  theme(legend.position = c(0.2, 0.75), 
        legend.title = element_text(size = 16), 
        legend.text = element_text(size = 12), 
        legend.margin = margin(0.25, 0.25, 0.5, 0.25, "cm")) +
  theme(plot.margin = unit(c(0.5, 0.5, 0.25, 0.25), "cm")) +
  geom_segment(aes(x = 0, y = -11.5635, xend = 20, yend = -10.9709), color = "dodgerblue3", size = 0.6) + 
  geom_segment(aes(x = 0, y = -11.5103, xend = 20, yend = -10.7633), color = "orangered3", size = 0.6) + 
  geom_segment(aes(x = 20, y = -10.5638, xend = 40, yend = -8.4318), color = "dodgerblue3", size = 0.6) + 
  geom_segment(aes(x = 20, y = -11.55917, xend = 40, yend = -7.45417), color = "orangered3", size = 0.6) + 
  geom_segment(aes(x = 40, y = -7.4127, xend = 64, yend = -0.3399), color = "dodgerblue3", size = 0.6) + 
  geom_segment(aes(x = 40, y = -4.4721, xend = 64, yend = -2.1489), color = "orangered3", size = 0.6)

```
  
*Mild hearing loss only*: Effect of PTA, no effect of Cognitive Category, weak interaction
```{r, echo=TRUE}
summary(lm(SRT ~ PTA.better * Cog.cat.num, subset(data2, PTA.group == "Mild")))
```
 
#### Figure 4. SRT-PTA residuals calculated from overall regression line
  
The SRT-PTA residuals are calculated from the regression line across all PTA Groups.      
There is no significant relationship between MoCA and residuals for the Normal and Mild groups. 
There is a significant relationship for the Moderate group; r = -0.39, p = 0.046. 
  
```{r, echo=FALSE}

# Overall regression SRT~PTA
m1 <- lm(SRT ~ PTA.better, data2)

# Extract residuals for three PTA Groups, from same regression line
resdata <- data.frame(residuals = m1$residuals)
resdata$PTA.group <- data2$PTA.group
resdata$PTA.better <- data2$PTA.better
resdata$MoCA.total <- data2$MoCA.total

# Residuals~MoCA regression lines for three individual PTA Groups, for plotting
m.normal <- lm(residuals ~ MoCA.total, resdata[resdata$PTA.group == "Normal", ])
m.mild <- lm(residuals ~ MoCA.total, resdata[resdata$PTA.group == "Mild", ])
m.moderate <- lm(residuals ~ MoCA.total, resdata[resdata$PTA.group == "Moderate", ])

# Plot scatter with y-axis=residuals and x-axis=MoCA; then plot regression lines on top 
# Coordinates for geom_segments were manually calculated using slopes and intercepts from above models
ggplot(data2, aes(y = m1$residuals, x = jitter(MoCA.total), colour = PTA.group, shape = PTA.group)) + 
  geom_point(size = 3) +
  scale_shape_manual(values = c(20, 2, 17)) + 
  scale_color_manual(values = c("seagreen3", "dodgerblue", "red1")) +
  scale_x_continuous(name = "MoCA total", limits = c(17.75, 30.25), breaks = seq(18, 30, 2)) +
  scale_y_continuous(name = "Predicted SRT - Actual SRT", limits=c(-4,8), breaks=seq(-4, 8, 2)) +
  annotate(geom = "text", x=20, y=4, label = "Poorer SRT than expected", size = 3) +
  annotate(geom = "text", x=20, y=-1.75, label = "Better SRT than expected", size = 3) +
  geom_hline(yintercept = 0, lty = "dashed", color = "black") + 
  geom_segment(x = 18.9, xend = 30.1, y = 0.4020779, yend = 0.1468081, colour="seagreen3", size=1) + 
  geom_segment(x = 17.8, xend = 30.2, y = -0.5230071, yend = -0.8522137, colour="dodgerblue", size=1) + 
  geom_segment(x = 19.5, xend = 29.5, y = 3.494582, yend = -0.2009475, colour = "red2", size = 1) + 
  theme_bw() + 
  theme(axis.title = element_text(size = 20), 
    axis.text = element_text(colour = "black", size = 16), 
    text = element_text(size = 16)) + 
  theme(legend.position = c(0.9, 0.85), 
        legend.title = element_text(size = 16), 
        legend.text = element_text(size = 12), 
        legend.margin = margin(0.25, 0.25, 0.5, 0.25, "cm"), 
        legend.box.background = element_rect(color = "grey50", size = 0.5)) +
  theme(plot.margin = unit(c(0.5, 0.5, 0.25, 0.25), "cm"))

```

```{r, echo=TRUE}

with(subset(resdata, PTA.group == "Normal"), cor.test(residuals, MoCA.total))
with(subset(resdata, PTA.group == "Mild"), cor.test(residuals, MoCA.total))
with(subset(resdata, PTA.group == "Moderate"), cor.test(residuals, MoCA.total)) 
```
  
#### Figure 5. Residuals calculated from group-specific regression line
  
```{r, echo=FALSE}

# SRT~PTA regressions for each PTA Group
m.normal <- lm(SRT ~ MoCA.total, data2[data2$PTA.group == "Normal", ])
m.mild <- lm(SRT ~ MoCA.total, data2[data2$PTA.group == "Mild", ])
m.moderate <- lm(SRT ~ MoCA.total, data2[data2$PTA.group == "Moderate", ])

# Extract residuals for three PTA Groups, from group-specific regression line
res.normal <- data.frame(residuals = m.normal$residuals, 
                         PTA.group = rep("Normal", 132), 
                         MoCA.total = data2[data2$PTA.group == "Normal", ]$MoCA.total)
res.mild <- data.frame(residuals = m.mild$residuals, 
                       PTA.group = rep("Mild", 103), 
                       MoCA.total = data2[data2$PTA.group == "Mild", ]$MoCA.total)  
res.moderate <- data.frame(residuals = m.moderate$residuals, 
                           PTA.group = rep("Moderate", 26),
                           MoCA.total = data2[data2$PTA.group == "Moderate", ]$MoCA.total)

resdata <- data.frame(rbind(res.normal, res.mild, res.moderate))
resdata$PTA.group <- factor(resdata$PTA.group, levels = c("Normal", "Mild", "Moderate"))
  
# Residuals~MoCA regressions for three individual PTA Groups, for plotting
m.normal <- lm(residuals ~ MoCA.total, resdata[resdata$PTA.group == "Normal", ])
m.mild <- lm(residuals ~ MoCA.total, resdata[resdata$PTA.group == "Mild", ])
m.moderate <- lm(residuals ~ MoCA.total, resdata[resdata$PTA.group == "Moderate", ])

# Plot scatter with y-axis=residuals and x-axis=MoCA; then plot regression lines on top 
# Coordinates for geom_segments were manually calculated using slopes and intercepts from above models
ggplot(resdata, aes(x = jitter(MoCA.total), y = residuals, colour = PTA.group, shape = PTA.group)) + 
  geom_point(size = 3) +
  scale_shape_manual(values = c(20, 2, 17)) + 
  scale_color_manual(values = c("seagreen3", "dodgerblue", "red1")) +
  scale_x_continuous(name = "MoCA total", limits = c(17.75, 30.25), breaks = seq(18, 30, 2)) +
  scale_y_continuous(name = "Predicted SRT - Actual SRT", limits=c(-6, 6), breaks=seq(-6, 6, 2)) +
  annotate(geom = "text", x=20, y=4, label = "Poorer SRT than expected", size = 3) +
  annotate(geom = "text", x=20, y=-4, label = "Better SRT than expected", size = 3) +
  geom_segment(x = 17.8, xend = 30.1, y = 8.16912e-17, yend = 5.59104e-17, colour="dodgerblue", size=1) + 
  geom_segment(x = 19, xend = 30, y = -1.5246e-16, yend = -2.36313e-16, colour="seagreen3", size=1) + 
  geom_segment(x = 19.8, xend = 29.2, y = -2.3578e-16, yend = 7.4088e-16, colour = "red2", size = 1) + 
  theme_bw() + 
  theme(axis.title = element_text(size = 20), 
    axis.text = element_text(colour = "black", size = 16), 
    text = element_text(size = 16)) + 
  theme(legend.position = c(0.9, 0.85), 
        legend.title = element_text(size = 14), 
        legend.text = element_text(size = 10), 
        legend.margin = margin(0.1, 0.1, 0.1, 0.1, "cm"), 
        legend.box.background = element_rect(color = "grey50", size = 0.25)) +
  theme(plot.margin = unit(c(0.5, 0.5, 0.25, 0.25), "cm"))

```
