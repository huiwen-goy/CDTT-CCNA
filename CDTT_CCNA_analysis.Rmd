---
title: "CDTT-CCNA data analysis"
output: html_document
---

```{r, echo=FALSE, results='hide', warnings='hide', messages='hide'}

# Read packages
library(psych)
library(ggplot2)

# Read data
all_data <- read.csv('ccna.full.05.27.2020.csv', header=TRUE, blank.lines.skip = TRUE,
                 stringsAsFactors=FALSE, na.strings=c("NA", "<NA>", "#NULL!", "", " "))

# Exclude some rows; select only a small subset of variables
data <- subset(all_data, Faisal..April..Allison == 1, 
               select=c(Age.ab, Cognitive.category, MoCA.Total...30., L250:R8000, T1.corrected.SRT))

# Rename some variables
colnames(data)[colnames(data) == "Age.ab"] <- "Age"
colnames(data)[colnames(data) == "MoCA.Total...30."] <- "MoCA.total"
colnames(data)[colnames(data) == "T1.corrected.SRT"] <- "SRT"

# Recode four cognitive categories to two
data$Cog.cat[data$Cognitive.category == "MCI-NoSubjective"] <- "MCI"
data$Cog.cat[data$Cognitive.category == "MCI"] <- "MCI"
data$Cog.cat[data$Cognitive.category == "Normal"] <- "Normal"
data$Cog.cat[data$Cognitive.category == "SCI"] <- "Normal"
# Order factor levels
data$Cog.cat <- factor(data$Cog.cat, levels = c("Normal", "MCI"))
# Check counts
table(data$Cog.cat)

# Recode two cognitive categories to numeric
data$Cog.cat.num[data$Cog.cat == "Normal"] <- 0
data$Cog.cat.num[data$Cog.cat == "MCI"] <- 1

# Calculate 4f-PTA better ear
data$LPTA <- (data$L500 + data$L1000 + data$L2000 + data$L4000) / 4
data$RPTA <- (data$R500 + data$R1000 + data$R2000 + data$R4000) / 4
data$PTA.better <- pmin(data$LPTA, data$RPTA)
# Check no NAs
sum(is.na(data$PTA.better))
# Check those on the border
data$PTA.better[data$PTA.better > 19 & data$PTA.better < 21]
data$PTA.better[data$PTA.better > 39 & data$PTA.better < 41]

# Classify participants according to PTA
data$PTA.group[data$PTA.better <= 20] <- "Normal"
data$PTA.group[data$PTA.better > 20 & data$PTA.better < 40] <- "Mild"
data$PTA.group[data$PTA.better >= 40] <- "Moderate"
# Order factor levels
data$PTA.group <- factor(data$PTA.group, levels = c("Normal", "Mild", "Moderate"))
# Check counts
table(data$PTA.group)

# Recode age into six ranges
data$Age.group <- ifelse(data$Age <= 60, "≤60", 
                         ifelse(data$Age > 60 & data$Age <= 65, "61-65",
                                ifelse(data$Age > 65 & data$Age <= 70, "66-70",
                                       ifelse(data$Age > 70 & data$Age <= 75, "71-75",
                                              ifelse(data$Age > 75 & data$Age <= 80, "76-80", "81+")))))
# Check grouping and level order
head(cbind(data$Age, data$Age.group), 20L)
table(data$Age.group)
stem(data$Age, 2)

```

### Relationship between Age, PTA, SRT and MoCA
```{r, echo=FALSE}

lowerMat(cor(cbind(data[, c('Age', 'PTA.better', 'SRT', 'MoCA.total')]), use="complete.obs", method="pearson"))

par(mfrow=c(1, 2))
plot(data$Age, data$PTA.better, ylab = "PTA", xlab = "Age", pch = 20)
plot(data$Age, jitter(data$MoCA.total), ylab = "MoCA", xlab = "Age", pch = 20)

par(mfrow=c(1, 3))
plot(data$Age, data$SRT, ylab = "SRT", xlab = "Age", pch = 20)
plot(data$PTA.better, data$SRT, ylab = "SRT", xlab = "PTA", pch = 20)
plot(jitter(data$MoCA.total), data$SRT, ylab = "SRT", xlab = "MoCA", pch = 20)

```

### A "third variable" in the relationship between SRT ~ PTA?
 
Note: Regression lines exclude a single outlier, but all datapoints are plotted.
 
```{r, echo=FALSE, results='hide'}

# Exclude one outlier for regression lines
data2 <- data[-which(data$PTA.better < 20 & data$SRT > 0), ]
# Regression line for each PTA Group (excluding outlier)
m.normal <- lm(SRT ~ PTA.better, subset(data2, PTA.group == "Normal"))
m.mild <- lm(SRT ~ PTA.better, subset(data2, PTA.group == "Mild"))
m.moderate <- lm(SRT ~ PTA.better, subset(data2, PTA.group == "Moderate"))

# Manually calculate regression line limits for three hearing gorups
summary(m.normal)
0.03318 * 0 - 11.53753 # 0, -11.53753
0.03318 * 20 - 11.53753 # 20, -10.87393
summary(m.mild)
0.16179 * 20 - 14.28681 # 20, -11.05101
0.16179 * 40 - 14.28681 # 40, -7.81521
summary(m.moderate)
0.25282 * 40 - 16.59692 # 40, -6.48412
0.25282 * 64 - 16.59692 # 64, -0.41644

# Further separating hearing groups into Normal and MCI
nh.normal <- lm(SRT ~ PTA.better, subset(data2, PTA.group == "Normal" & Cog.cat == "Normal"))
nh.mci <- lm(SRT ~ PTA.better, subset(data2, PTA.group == "Normal" & Cog.cat == "MCI"))
mild.normal <- lm(SRT ~ PTA.better, subset(data2, PTA.group == "Mild" & Cog.cat == "Normal"))
mild.mci <- lm(SRT ~ PTA.better, subset(data2, PTA.group == "Mild" & Cog.cat == "MCI"))
moderate.normal <- lm(SRT ~ PTA.better, subset(data2, PTA.group == "Moderate" & Cog.cat == "Normal"))
moderate.mci <- lm(SRT ~ PTA.better, subset(data2, PTA.group == "Moderate" & Cog.cat == "MCI"))

summary(nh.normal)
0.02529 * 0 - 11.49718 #x = 0, y = -11.49718, xend = 20, yend = -10.99138
0.02529 * 20 - 11.49718 
summary(nh.mci)
0.04390 * 0 - 11.58446 #x = 0, y = -11.58446, xend = 20, yend = -10.70646
0.04390 * 20 - 11.58446 
summary(mild.normal)
0.11135 * 20 - 12.97115 #x = 20 , y = -10.74415, xend = 40, yend = -8.51715
0.11135 * 40 - 12.97115 
summary(mild.mci)
0.22382 * 20 - 15.96149 #x = 20, y = -11.48509, xend = 40, yend = -7.00869
0.22382 * 40 - 15.96149
summary(moderate.normal)
0.3563 * 40 - 21.8410 #x = 40, y = -7.589, xend = 64, yend = 0.9622
0.3563 * 64 - 21.8410 
summary(moderate.mci)
0.13725 * 40 - 10.26853 #x = 40, y = -4.77853, xend = 64, yend = -1.48453
0.13725 * 64 - 10.26853 

```

```{r, echo=FALSE}

# Plot SRT ~ PTA, age colour-coded (includes outlier)
ggplot(data, aes(x = jitter(PTA.better), y = SRT, color = Age.group)) +
  geom_point(size = 3) + 
  scale_color_manual(labels = c("≤60", "61-65", "66-70", "71-75", "76-80", "81+"), 
                name = "Age Group", 
                values = c("springgreen3", "dodgerblue1", "dodgerblue3", "sienna1", "sienna3", "red")) +
  scale_x_continuous(name = "PTA better ear", limits = c(-5,65), expand = c(0,0), breaks = seq(-5,65,5)) + 
  scale_y_continuous(name = "SRT", limits = c(-14,4), expand = c(0,0), breaks = seq(-14,4,2)) + 
  theme(axis.title = element_text(size = 20), 
    axis.text = element_text(colour = "black", size = 16), 
    text = element_text(size = 16)) + 
  theme(legend.position = c(0.15, 0.7)) + 
  theme(plot.margin = unit(c(0.5, 0.5, 0.25, 0.25), "cm")) + 
  geom_segment(aes(x = 0, y = -11.53753, xend = 20, yend = -10.87393), color = "black", size = 0.8) + 
  geom_segment(aes(x = 20, y = -11.05101, xend = 40, yend = -7.81521), color = "black", size = 0.8) + 
  geom_segment(aes(x = 40, y = -6.48412, xend = 64, yend = -0.41644), color = "black", size = 0.8)

# Plot SRT ~ PTA, MoCA colour-coded (midpoint = 25)
ggplot(data, aes(x = jitter(PTA.better), y = SRT, color = MoCA.total)) +
  geom_point(size = 3) + 
  scale_colour_gradient2(low = "red", mid = "white", high = "blue", midpoint = 25, name = "MoCA total") +
  scale_x_continuous(name = "PTA better ear", limits = c(-5,65), expand = c(0,0), breaks = seq(-5,65,5)) + 
  scale_y_continuous(name = "SRT", limits = c(-14,4), expand = c(0,0), breaks = seq(-14,4,2)) + 
  theme(axis.title = element_text(size = 20), 
    axis.text = element_text(colour = "black", size = 16), 
    text = element_text(size = 16)) + 
  theme(legend.position = c(0.15, 0.7)) + 
  theme(plot.margin = unit(c(0.5, 0.5, 0.25, 0.25), "cm")) + 
  theme(panel.background = element_rect(fill = 'black', colour = 'black')) + 
  theme(panel.grid = element_line(colour = '#999999')) + 
  geom_segment(aes(x = 0, y = -11.53753, xend = 20, yend = -10.87393), color = "yellow", size = 0.8) + 
  geom_segment(aes(x = 20, y = -11.05101, xend = 40, yend = -7.81521), color = "yellow", size = 0.8) + 
  geom_segment(aes(x = 40, y = -6.48412, xend = 64, yend = -0.41644), color = "yellow", size = 0.8)

# Plot SRT ~ PTA, cognitive category colour-coded (blue = normal, red = MCI)
# Separate regression lines for Normal and MCI
ggplot(data, aes(x = jitter(PTA.better), y = SRT, color = Cog.cat)) +
  geom_point(size = 3, alpha = 0.75) + 
  scale_colour_manual(labels = c("Normal", "MCI"), name = "Category", values = c("dodgerblue", "red")) +
  scale_x_continuous(name = "PTA better ear", limits = c(-5,65), expand = c(0,0), breaks = seq(-5,65,5)) + 
  scale_y_continuous(name = "SRT", limits = c(-14,4), expand = c(0,0), breaks = seq(-14,4,2)) + 
  theme(axis.title = element_text(size = 20), 
    axis.text = element_text(colour = "black", size = 16), 
    text = element_text(size = 16)) + 
  theme(legend.position = c(0.15, 0.7)) + 
  theme(plot.margin = unit(c(0.5, 0.5, 0.25, 0.25), "cm")) + 
  theme(panel.background = element_rect(fill = 'black', colour = 'black')) + 
  theme(panel.grid = element_line(colour = '#999999')) + 
  geom_segment(aes(x = 0, y = -11.49718, xend = 20, yend = -10.99138), color = "skyblue", size = 0.6) + 
  geom_segment(aes(x = 0, y = -11.58446, xend = 20, yend = -10.70646), color = "orangered", size = 0.6) + 
  geom_segment(aes(x = 20 , y = -10.74415, xend = 40, yend = -8.51715), color = "skyblue", size = 0.6) + 
  geom_segment(aes(x = 20, y = -11.48509, xend = 40, yend = -7.00869), color = "orangered", size = 0.6) + 
  geom_segment(aes(x = 40, y = -7.589, xend = 64, yend = 0.9622), color = "skyblue", size = 0.6) + 
  geom_segment(aes(x = 40, y = -4.77853, xend = 64, yend = -1.48453), color = "orangered", size = 0.6)

```

```{r, echo=TRUE}

head(data.frame(data$Cognitive.category, data$Cog.cat, data$MoCA.total), 20L)

par(mfrow=c(1, 2))
hist(data[data$Cognitive.category == "Normal", ]$MoCA.total, main = "", xlab = "MoCA total", breaks=10)
hist(data[data$Cognitive.category == "MCI", ]$MoCA.total, main = "", xlab = "MoCA total", breaks=10)

```

### Does cognition change the relationship between PTA and SRT?
Note: Exclude single outlier for regressions.
  
**MoCA as a continuous variable**
 
Conclusion: MoCA only changes the relationship between PTA-SRT for the mild hearing loss group.
```{r, echo=TRUE}

# Across all participants
summary(lm(SRT ~ PTA.better * MoCA.total, data2))

# Normal hearing only
summary(lm(SRT ~ PTA.better * MoCA.total, subset(data2, PTA.group == "Normal")))

# PTA mild only
summary(lm(SRT ~ PTA.better * MoCA.total, subset(data2, PTA.group == "Mild")))

# PTA moderate only
summary(lm(SRT ~ PTA.better * MoCA.total, subset(data2, PTA.group == "Moderate")))

```
 
**Cognitive category as a two-level factor**
 
Conclusion: Do not see an effect of cognitive category for the mild hearing loss group.
```{r, echo=TRUE}

# PTA mild only
summary(lm(SRT ~ PTA.better * Cog.cat.num, subset(data2, PTA.group == "Mild")))

```
 
### Residuals (PTA ~ Age)
```{r, echo=FALSE}

# Regression: PTA ~ Age
m1 <- lm(PTA.better ~ Age, data)

par(mfrow=c(1, 2))
# Plot PTA ~ Age
plot(data$PTA.better ~ jitter(data$Age), main = "PTA ~ Age")
# Plot residuals ~ Age
plot(m1$residuals ~ jitter(data$Age), main = "residuals ~ Age")

par(mfrow=c(1, 2))
# Plot SRT ~ PTA
colours <- c("darkgreen", "dodgerblue", "darkred")
shapes <- c(20, 2, 17)
plot(data$SRT ~ data$PTA.better, main = "SRT ~ PTA", 
     cex = 1.5, pch = shapes[data$PTA.group], col = colours[data$PTA.group])
# Plot SRT ~ PTA-Age residuals
plot(data$SRT ~ m1$residuals, main = "SRT ~ [PTA minus Age]", 
     cex = 1.5, pch = shapes[data$PTA.group], col = colours[data$PTA.group])

```

